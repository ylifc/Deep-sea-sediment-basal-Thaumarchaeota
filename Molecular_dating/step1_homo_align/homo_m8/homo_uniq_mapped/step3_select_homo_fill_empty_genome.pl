#!/usr/bin/perl -w
use warnings;

$homo_uniq_path = "$ARGV[0]"; #cds after blsat against homo database, the dir save the m8 files
$genomes_dir = "$ARGV[1]";#the dir saves the genome files
$homo_uniq_path =~ s/\/$//;
$genomes_dir =~ s/\/$//;
%hash=();
%hash2=();
%hash3=();
opendir DIR, $homo_uniq_path|| die "can not open dir \"$DIR\"\n";
@filelist = readdir DIR;
foreach $file (@filelist) {
	if ($file =~m/_uniq.fa/) {
			open IN, "<$file";
			while ($lines=<IN>) {
				chomp $lines;
				if ($lines=~m/>/) {
					$lines=~s/>//;
					$file=~s/_uniq\.fa//;
					$hash{$file}+=1;
					#		$hash3{$lines}=1;
					}
				}
			}
		}
		open OU, ">homo_name_temp.txt";
		foreach $homo_name (keys %hash) {
			print OU "$homo_name\t$hash{$homo_name}\n";
		}
		close IN;
		close OU;
		close DIR;
		system("sort -nr -k2 homo_name_temp.txt|cat -n");
		print "please enter the numerb of homo genes you want to maintain\n";
		$number=  <STDIN>;
		chomp($number); 
		system("sort -nr -k2 homo_name_temp.txt|head -$number > homo_name_temp_sorted.txt");
		opendir DIR2, $genomes_dir|| die "can not open dir \"$genomes_dir\"\n";
		@file2 = readdir DIR2;
		foreach $file2 (@file2) {
				if ($file2=~m/\.fa$/){
				$genome_name= $file2;
				$genome_name =~ s/_renamed.fa//;
				$hash2{$genome_name}=1;
			}
		}
			close DIR2;
		open IN2, "<homo_name_temp_sorted.txt";
		while ($line2=<IN2>) {
			$homo_name2=(split /\s+/,$line2)[0];
			#print "$homo_name2\n";
			#	$file_name2="$homo_name2\_uniq\.fa";
			open IN3, "<$homo_name2\_uniq\.fa";
			open OU2, ">$homo_name2\_empty_filled.fa";
			%hash3=();
			while ($line3= <IN3>) {
				chomp $line3;
				if ($line3=~m/>/) {
					$line3=~s/>//;
					$genome_name_in_homo_orig = $line3;
				} else {
					$hash3{$genome_name_in_homo_orig}=$line3;
				}
			}
			close IN3;
						foreach $complete_genome_list (keys %hash2) {
							if ($hash3{$complete_genome_list}) {
								print OU2 ">$complete_genome_list\n";
								print OU2 "$hash3{$complete_genome_list}\n"
							}else {
									print OU2 ">$complete_genome_list\n";
									print OU2 "-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n";
								}
							} close OU2;
			}
			close IN2;
			system("mkdir step3_fill_empty");
			system("mv *_empty_filled.fa step3_fill_empty/");
